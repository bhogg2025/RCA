BLOCKER: dev-login returns ok:true but whoami is false â†’ session cookie not persisted.

1) Middleware ORDER (must be before any routes/static/catch-all)
app.set('trust proxy', 1);
app.use(cookieParser());
app.use(session({
  secret: process.env.JWT_SECRET,
  resave: false,
  saveUninitialized: false,
  name: 'sid',
  cookie: {
    httpOnly: true,
    sameSite: 'lax',
    secure: true,          // replit.dev is HTTPS; trust proxy is set
    maxAge: 7 * 24 * 3600 * 1000
  }
}));

2) Dev-login must REGENERATE and SAVE the session before responding
app.post('/api/auth/dev-login', (req, res, next) => {
  if (process.env.EMAIL_DEV_MODE !== 'true') {
    return res.status(404).json({ code:'NOT_FOUND' });
  }
  req.session.regenerate(err => {
    if (err) return next(err);
    req.session.user = { id:'dev', email:'dev@local', roles:['admin'] };
    req.session.save(err2 => {
      if (err2) return next(err2);
      // explicit: prevent caches
      res.set('Cache-Control', 'no-store');
      return res.json({ ok: true });
    });
  });
});

3) whoami (debug)
app.get('/api/admin/whoami', (req, res) => {
  const u = req.user || req.session?.user || null;
  res.json({ authenticated: !!u, roles: u?.roles || [] });
});

4) Admin guard (cookie session only)
function adminOnly(req,res,next){
  const u = req.user || req.session?.user;
  if (!u) return res.status(401).json({ code:'UNAUTHENTICATED', message:'Sign in' });
  const roles = u.roles || (u.role ? [u.role] : []);
  if (!roles.includes('admin')) return res.status(403).json({ code:'FORBIDDEN', message:'Admin only' });
  next();
}

5) Route registration ORDER
- Register the middleware and the two endpoints above BEFORE:
  - app.use(express.static(...))
  - any SPA catch-all: app.get('*', ...)
- All admin APIs use adminOnly and return JSON on errors.

6) Verify locally and paste results:
curl -i -X POST http://localhost:5000/api/auth/dev-login
curl -s http://localhost:5000/api/admin/whoami
curl -i http://localhost:5000/api/admin/ai/providers
Expect: whoami.authenticated=true and providers=200.
